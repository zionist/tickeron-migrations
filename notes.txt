https://docs.google.com/document/d/1EIbNOiZxhubIo_p_pA7ayYffR_TsxjFv4FB8lMKCuQ0/edit#

Connection string Z:\tickeron\tickeron_main\Advisory.Migrator\bin\Debug>DbUpgradeManager.exe reset-views  -c "Data Source=.\;Initial Catalog=Advisory;Integrated security=true"

Test cases:
DbUpgradeManager.exe reset-views  -c "Data Source=.\;Initial Catalog=Advisory;Integrated security=true"

../../UDF.xml захардкодено?



Tests setup:

1. compile project Advisory.Migrator
2. cp -r Advisory.Migrator/bin/Debug .
3. make Root xml element location="..\..\SQL\DataMigration" in UDF.xml
4. copy backups dir to C: drive. Do not know why MSSQL does not want to import from network disk(

Test data base:
drop table backup_info; pria
drop table migrations;
drop table name;

drop table backup_info;
drop table migrations;
drop table name;


========= udf validation tests =======

Test case: recount checksums for files: passed
	DbUpgradeManager.exe reset-udf
48,170 - UDF file was updated.

Test case: recount checksums for files list: passed
	DbUpgradeManager.exe reset-udf
48,170 - UDF file was updated.


======= Error tests =======

Duplicate two same scripts in different releases.
	Z:\tickeron\tickeron-migrations\bin\Debug>DbUpgradeManager.exe reset-udf
	Advisory.Migrator.Program 2015-10-14 17:34:05,608 - Cross migration duplicate sc
	ripts was founded, release_v1_1.sql, release_v1_2.sql.
	Advisory.Migrator.Program 2015-10-14 17:34:05,623 - UDF is invalid.


======= backup restoration mode test ===========

Warning: works only with precreated empty database.

Data:
	Two releases with 2 versions: 1, 2. Each has primary and secondary different backup data.
	One data migration in each release


Test case: restore primary backup from 2nd version. Passed
DbUpgradeManager.exe restore -t primary -f Advisory_fact -m Advisory -c "Data Source=.\;Integrated security=true"

Test case: respore secondary backup from 2nd version. Passed
DbUpgradeManager.exe restore -t secondary -f Advisory_fact -m Advisory -c "Data Source=.\;Integrated security=true"

Test case: restore primary backup from 1st version. Failed. Release version 2 migration ran.
DbUpgradeManager.exe restore -t primary -v 1 -f Advisory_fact -m Advisory -c "Data Source=.\;Integrated security=true"
	Advisory.Migrator.Helper.CxVersionHelper 2015-10-14 19:05:24,907 - Successfully
	find specified destination version 1.0.
	Advisory.Migrator.Implementation.MigrationTasks.CxRestoreTask 2015-10-14 19:05:2
	4,969 - Starting restore Advisory from version 1.0, backup C:\Backups\Advisory_p
	rimary_v1.bak.
	Advisory.Migrator.Implementation.MigrationTasks.CxRestoreTask 2015-10-14 19:05:2
	5,532 - Restore "Advisory" completed successfully in 0.573s.
	Advisory.Migrator.Implementation.MigrationTasks.CxRestoreTask 2015-10-14 19:05:2
	5,547 - Starting restore Advisory_fact from version 1.0, backup C:\Backups\Advis
	ory_fact_primary_v1.bak.
	Advisory.Migrator.Implementation.MigrationTasks.CxRestoreTask 2015-10-14 19:05:2
	6,016 - Restore "Advisory_fact" completed successfully in 0.477s.
	Advisory.Migrator.Implementation.MigrationTasks.CxDeployBase 2015-10-14 19:05:26
	,032 - Restoring migrations starting from version 1.0
	Advisory.Migrator.Implementation.MigrationTasks.CxDeployBase 2015-10-14 19:05:26
	,047 - Applying migration 1.0.
	Advisory.Migrator.Implementation.MigrationTasks.CxDeployBase 2015-10-14 19:05:26
	,047 - Running script Z:\tickeron\tickeron-migrations\SQL\DataMigration\release_
	v1_1.sql...
	Advisory.Migrator.Implementation.MigrationTasks.CxDeployBase 2015-10-14 19:05:26
	,125 - Applying migration 2.0.                                                      <---!
	Advisory.Migrator.Implementation.MigrationTasks.CxDeployBase 2015-10-14 19:05:26
	,141 - Running script Z:\tickeron\tickeron-migrations\SQL\DataMigration\release_
	v2_1.sql...                                                                         <---!

	По факту у нас в view записалоось что прошло две миграции,а по факт упрошло три
	select * from UpgradeLevel_VW;
	Version	Hotfix	Checksum
	1	0	0e161e38941434e0e24dd59e8a9aa65c
	2	0	ddde0b225f20c8f530b2c04b1bcf806b

	select * from migrations;
	version	release	hotfix	
	1	1	NULL	
	1	2	NULL	
	2	2	NULL	



Почему restore mode прогоняет миграции в последнем релизе? Зачем нужен deploy mode тогда?
Почему deploy mode прогоняет те же миграции в последнем релизе после restore mode?
Почему deploy mode прогоняет одни и те же скрипты миграции в последнем релизе повторно при повторе команды? 
Почему deply mode не определяет случай добавления скрипта в предыдущий релиз?


============ deploy mode =============



Test case: respore secondary backup from last version. Failed. Version 2 migration ran.
DbUpgradeManager.exe restore -t secondary -v 1 -f Advisory_fact -m Advisory -c "Data Source=.\;Integrated security=true"

TODO: hotfix test cases






Z:\tickeron\tickeron-migrations\bin\Debug>DbUpgradeManager.exe restore -t primary -f Advisory_fact -m Advisory -v 1  -c "Data Source=.\;Integrated security=true
Z:\tickeron\tickeron-migrations\bin\Debug>



